<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Chá»n Ä‘á»‹a chá»‰ phÃ²ng</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
    />

    <style>
      body {
        font-family: Arial;
        margin: 20px;
      }

      .container {
        max-width: 800px;
        margin: auto;
      }

      #map {
        height: 350px;
        margin-top: 10px;
        border-radius: 10px;
      }

      label {
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>ğŸ“ Äá»‹a chá»‰ phÃ²ng trá»</h2>

      <label>Nháº­p Ä‘á»‹a chá»‰:</label>
      <div id="search"></div>

      <div id="map"></div>

      <p><b>Äá»‹a chá»‰ Ä‘Ã£ chá»n:</b></p>
      <div id="result">ChÆ°a chá»n</div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
      const map = L.map('map').setView([21.0285, 105.8523], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      let marker;

      // ===== SEARCH ADDRESS =====
      const geocoder = L.Control.geocoder({
        placeholder: 'Nháº­p Ä‘á»‹a chá»‰ phÃ²ng...',
        defaultMarkGeocode: false,
      }).addTo(map);

      // Khi user chá»n Ä‘á»‹a chá»‰
      geocoder.on('markgeocode', function (e) {
        const latlng = e.geocode.center;
        const address = e.geocode.name;

        map.setView(latlng, 17);

        if (marker) map.removeLayer(marker);

        marker = L.marker(latlng, { draggable: true }).addTo(map);

        updateAddress(latlng.lat, latlng.lng, address);

        // cho phÃ©p kÃ©o chá»‰nh
        marker.on('dragend', async function (ev) {
          const pos = ev.target.getLatLng();

          const res = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lng}`,
          );

          const data = await res.json();

          updateAddress(pos.lat, pos.lng, data.display_name);
        });
      });

      function updateAddress(lat, lng, address) {
        document.getElementById('result').innerHTML = `
        ğŸ“Œ ${address}<br>
        ğŸŒ Lat: ${lat.toFixed(6)}<br>
        ğŸŒ Lng: ${lng.toFixed(6)}
    `;

        console.log({
          latitude: lat,
          longitude: lng,
          address: address,
        });
      }
    </script>
  </body>
</html>
